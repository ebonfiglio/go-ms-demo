<!doctype html>
<html>
    <head>
        <title>{{.Title}}</title>
    </head>
    <body>
        <h1>Organizations Management</h1>

        <p><a href="/">&larr; Back to Dashboard</a></p>

        <h2>Add New Organization</h2>
        <form id="add-form">
            <input
                type="text"
                id="org-name"
                placeholder="Organization name"
                required
                minlength="2"
                maxlength="100"
            />
            <button type="submit">Add Organization</button>
        </form>

        <h2>Organizations List</h2>
        <button onclick="loadOrganizations()">Refresh</button>

        <table border="1" id="org-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="org-tbody"></tbody>
        </table>

        <div id="message"></div>

        <script>
            const API_URL = "{{.OrganizationServiceURL}}";

            // Load organizations on page load
            document.addEventListener("DOMContentLoaded", loadOrganizations);

            // Handle form submission
            document
                .getElementById("add-form")
                .addEventListener("submit", function (e) {
                    e.preventDefault();
                    const name = document
                        .getElementById("org-name")
                        .value.trim();
                    if (name) {
                        createOrganization(name);
                    }
                });

            // Load all organizations
            async function loadOrganizations() {
                try {
                    showMessage("Loading organizations...", "info");

                    const response = await fetch(`${API_URL}/organizations`);

                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const data = await response.json();
                    const organizations = data.data || [];

                    displayOrganizations(organizations);
                    showMessage(
                        `Loaded ${organizations.length} organizations`,
                        "success",
                    );
                } catch (error) {
                    console.error("Error loading organizations:", error);
                    showMessage(
                        "Error loading organizations: " + error.message,
                        "error",
                    );
                }
            }

            // Display organizations in table
            function displayOrganizations(organizations) {
                const tbody = document.getElementById("org-tbody");
                tbody.innerHTML = "";

                if (organizations.length === 0) {
                    tbody.innerHTML =
                        '<tr><td colspan="3">No organizations found</td></tr>';
                    return;
                }

                organizations.forEach((org) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                    <td>${org.id}</td>
                    <td id="name-${org.id}">${escapeHtml(org.name)}</td>
                    <td>
                        <button onclick="editOrganization(${org.id})">Edit</button>
                        <button onclick="deleteOrganization(${org.id})">Delete</button>
                    </td>
                `;
                    tbody.appendChild(row);
                });
            }

            // Create new organization
            async function createOrganization(name) {
                try {
                    showMessage("Creating organization...", "info");

                    const response = await fetch(`${API_URL}/organizations`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ name: name }),
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(
                            error.error ||
                                error.details ||
                                `HTTP error! status: ${response.status}`,
                        );
                    }

                    const organization = await response.json();
                    showMessage(
                        `Organization "${organization.name}" created successfully!`,
                        "success",
                    );

                    // Clear form and reload
                    document.getElementById("org-name").value = "";
                    loadOrganizations();
                } catch (error) {
                    console.error("Error creating organization:", error);
                    showMessage(
                        "Error creating organization: " + error.message,
                        "error",
                    );
                }
            }

            // Edit organization
            async function editOrganization(id) {
                const nameCell = document.getElementById(`name-${id}`);
                const currentName = nameCell.textContent;

                const newName = prompt("Enter new name:", currentName);
                if (
                    !newName ||
                    newName.trim() === "" ||
                    newName === currentName
                ) {
                    return;
                }

                try {
                    showMessage("Updating organization...", "info");

                    const response = await fetch(
                        `${API_URL}/organizations/${id}`,
                        {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ name: newName.trim() }),
                        },
                    );

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(
                            error.error ||
                                error.details ||
                                `HTTP error! status: ${response.status}`,
                        );
                    }

                    const organization = await response.json();
                    showMessage(
                        `Organization updated to "${organization.name}"!`,
                        "success",
                    );
                    loadOrganizations();
                } catch (error) {
                    console.error("Error updating organization:", error);
                    showMessage(
                        "Error updating organization: " + error.message,
                        "error",
                    );
                }
            }

            // Delete organization
            async function deleteOrganization(id) {
                if (
                    !confirm(
                        "Are you sure you want to delete this organization?",
                    )
                ) {
                    return;
                }

                try {
                    showMessage("Deleting organization...", "info");

                    const response = await fetch(
                        `${API_URL}/organizations/${id}`,
                        {
                            method: "DELETE",
                        },
                    );

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(
                            error.error ||
                                `HTTP error! status: ${response.status}`,
                        );
                    }

                    showMessage(
                        "Organization deleted successfully!",
                        "success",
                    );
                    loadOrganizations();
                } catch (error) {
                    console.error("Error deleting organization:", error);
                    showMessage(
                        "Error deleting organization: " + error.message,
                        "error",
                    );
                }
            }

            // Show message to user
            function showMessage(message, type) {
                const messageDiv = document.getElementById("message");
                messageDiv.textContent = message;

                // Simple styling without CSS classes
                if (type === "error") {
                    messageDiv.style.color = "red";
                    messageDiv.style.backgroundColor = "#ffeeee";
                    messageDiv.style.padding = "10px";
                    messageDiv.style.border = "1px solid red";
                } else if (type === "success") {
                    messageDiv.style.color = "green";
                    messageDiv.style.backgroundColor = "#eeffee";
                    messageDiv.style.padding = "10px";
                    messageDiv.style.border = "1px solid green";
                } else if (type === "info") {
                    messageDiv.style.color = "blue";
                    messageDiv.style.backgroundColor = "#eeeeff";
                    messageDiv.style.padding = "10px";
                    messageDiv.style.border = "1px solid blue";
                }

                // Clear message after 5 seconds
                setTimeout(() => {
                    messageDiv.textContent = "";
                    messageDiv.style.color = "";
                    messageDiv.style.backgroundColor = "";
                    messageDiv.style.padding = "";
                    messageDiv.style.border = "";
                }, 5000);
            }

            // Escape HTML to prevent XSS
            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }
        </script>
    </body>
</html>
